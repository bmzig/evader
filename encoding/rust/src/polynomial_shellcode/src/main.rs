use std::{
    mem, 
    ptr,
    time::{
        Instant,
        Duration,
    },
    thread,
};

use ff::PrimeField;
use mmap::*;

#[derive(PrimeField)]
#[PrimeFieldModulus = "18446744069414584321"] // 2^64 - 2^32 + 1
#[PrimeFieldGenerator = "3"]
#[PrimeFieldReprEndianness = "little"]
pub struct Goldilocks([u64; 2]);

fn main() {

    let now = Instant::now();
    thread::sleep(Duration::new(4, 0));
    let after = Instant::now();
    if (after - Duration::new(3, 1000)) < now { return; }

    let data: [u64; 512] = [18374686475393433712, 5619846777703897658, 7888562514372060628, 15615372905029151353, 13842166641194912052, 15575495279653180102, 10622200220699269324, 1573056930416487867, 16848633418657999433, 9305305219016353330, 9965700986317292001, 4421401561533161019, 17303368392421827471, 5486573554841663643, 3393909387047498713, 1917644000228733087, 1887712566498434560, 10921195110997340699, 14675466750132430630, 7937799816754355003, 16001213827359036817, 13050966994736163904, 10608446374840665529, 16133058719072346958, 13405716068293660001, 4345465579840378147, 463168614293773335, 14413396975651317543, 9007894431495435330, 11099361302727894438, 10486080229795816731, 9754149784098254657, 14040234042006246954, 9585727222876741087, 13560002279707564305, 5062828763480169869, 2503894407395194022, 12842220634941503712, 13682147163592969993, 10021070460648014004, 683393465581895612, 4694695475904646058, 1285455399043428484, 8475558744906198837, 13154280276768618861, 3078519628578743008, 4485143588159420755, 10113761149230709755, 4170774040659220255, 9893450980828969001, 5736049571911530533, 14459550188368203028, 2568095127650670405, 17284562366057617406, 890190069560737071, 7084296070647640532, 5707259495342727707, 16111684775020448785, 1077743729962698314, 17916208858313288469, 3653184814780639810, 14271921689330794735, 6941191570383719184, 14349119082813871919, 12441514129983885709, 5595365633015568499, 5656412992122727936, 444586475921227091, 16682784569694045678, 8154620091947154806, 3819808716596582670, 1816621959146504740, 3514656416558015347, 2182840336936175529, 16988857275730513657, 17837544015355463186, 10813978883387855250, 16095633248774438628, 16339325013284564505, 573762934821927559, 12845880643580250176, 3715247553901949746, 8125348430635280477, 2719618276822876292, 4654735565009707141, 15497308584792724387, 5143441599775612786, 11746249452709295683, 11952986580377164804, 17609871761348211508, 7308962583780406951, 1849912545563407966, 3264021741117491695, 17997513740939986433, 5912242492101114434, 1935913276542552015, 17762379160321813764, 3656407227729355865, 6211852970688137166, 11795207446322519803, 5377406801443563996, 10222558075872256394, 3339830659353760339, 673172855531426410, 11023382295916709801, 7776741505851085042, 15960987693704537045, 5880950211325783479, 10218672721867699248, 13600925502337583448, 14060519993346421708, 4035419529781656749, 1815031950933863784, 4186224468603290325, 11738908405029969888, 1008872722142360515, 7370307722843970055, 5130434603389631906, 1696861812339345266, 17068198926274405546, 15759231637612585618, 11770298782555197037, 17461619870255627750, 14097109733465169905, 11751045827178793216, 2200984881966373081, 2178380090166806695, 7383530309345847754, 14301190356983431672, 13175826918215450098, 4749213389236921739, 162491566409565708, 11628171335441326362, 5966355702373607463, 5430084165338623667, 16771199725431400778, 2753971105908577970, 5188675927357817100, 16776761316935301130, 14066430592784656323, 8957936539583561705, 7980532113322246032, 17798147001926173872, 13069264505290639334, 8358655831914800426, 11547289832631471197, 16014394065292462951, 10725171533033426376, 6791934032434528445, 12811388284056046892, 12268671268195000280, 14586875404350402624, 3085649292959945445, 18198975780357428889, 4101777546641838033, 91773100328346777, 10989376685003916746, 954778185007643041, 4846499858371092951, 17019312123828109820, 3315898294642392925, 16081230716714274763, 8073756891325982570, 17222863016661801964, 10711618531926131753, 10181749291352474147, 15622122197422937377, 628946714022006229, 7039819359047534467, 7797773923422337881, 3589246574576406259, 9836124772612979008, 6006781331490965176, 17197984989986684090, 6236879568061461424, 15816710947899570541, 1433177636916681880, 754381246990859661, 5300802742748798330, 6763026027938008327, 17884416445238286073, 8309170842947176978, 9302168972266990557, 10741710636469303527, 13844930404789569327, 966165841684767862, 13967499361819336543, 1526791545652332217, 7517075726507552058, 15697025332978552740, 8385622116589433654, 13890146217837273841, 14253405527558251199, 13798796068043563855, 13747454468954762708, 2135655649696673157, 8393736697363816719, 10720238610051832267, 5818975771298702415, 8978075697187845688, 8171828167562916274, 13320571818798302978, 17792112062129541473, 7901780816947743908, 12233693464264652203, 10005566856198495134, 759456750885868567, 5136277677488778952, 3917868754497016428, 17204730220189172037, 15980994517846254025, 10739716077805823086, 707150705409087266, 416201823760277509, 15231206455023924546, 4032536488286796443, 9725566636871802708, 10363039804871363500, 10904815695961020484, 15812881199954089667, 6025035302071966333, 5323374752031290535, 9216177812971294855, 11907752152343627903, 14905322661275345052, 4143455775553451684, 2158086721910610497, 18041852237766133915, 888923480633184153, 6467480853497534938, 4178345315908669460, 1717632352023832959, 13919601011286318414, 10620416583463833562, 4333655220359081732, 9619978226686524342, 9910836839229082445, 3782422912295404245, 3067892525264263267, 17633934211449577782, 2917853911430055913, 16677907581762689920, 13334360387587901779, 11626684746332189827, 15168621184284989416, 8683557111307614409, 13923728143646157462, 15943797094453372281, 5692586963964699774, 4218292848928667019, 12571826008829895720, 6351216596469586301, 9720460101006481778, 10674624481831390940, 11030746032254909250, 13274631126604274841, 13402712487934033920, 16066899101729074350, 1146298886159376657, 12099327742011293849, 938355704611798509, 9296162523566576428, 9513868464351260361, 9872437481270169622, 13377129946241353436, 15007350030564420803, 8363968317844055493, 1864779874869756947, 418498860871942465, 12290366166829346758, 3008783744606671212, 13556045007436036429, 15621639300012829488, 10991793295455344850, 6396319982839509431, 9856551973104839670, 3458377058222537650, 10542973230605313327, 92040987165656019, 12366636735481480555, 4095444362295044382, 8285617776055321357, 17300865980572920541, 13482447906697279316, 16284154762820829122, 12962495233807766250, 13443670614762659953, 12520036061802151419, 5747956855699073515, 14501480235563299036, 15266871329440471737, 13186681535664289513, 9566250268425644422, 2603412704995770390, 10911802366407439341, 5411796167338384443, 14796338894782162578, 11255161803088205209, 12101687345169114119, 16134740220125808308, 6375443764503562965, 7186998396849040118, 3326139345580645563, 2973159367217809219, 13709319618140206837, 15233757880527362333, 3885355254153141023, 12942493543142466302, 12041100586301820192, 13518451081849112292, 15417720115147497030, 10262132417659643474, 8945389681326248886, 13019033875249782384, 17918853869059127095, 14097979257447175095, 14436028703740151323, 1705812041363564060, 5640885051726849712, 15072059670189186774, 14670302927146321721, 9887867304931021275, 5701496367048651090, 5022259944663271284, 10690679783458130174, 2146516295607553656, 11961105833609951353, 530891669211398370, 1434379308839754165, 11199462414756809993, 4609956468717223872, 5145516331499565303, 5289278886716253391, 9508580034766231209, 10040833577843491874, 14073816449228270767, 984693174678403258, 8431891788834291480, 6945916524518648798, 6131396180955642700, 4225816317989346288, 3910528411870874521, 6096778420253177365, 6676975090813844234, 11286234136638151660, 5757681892207072789, 16312547234467550254, 5008049249116069893, 13854501194327684415, 11076439650763321410, 16084048864297759622, 4946864097484510683, 2350225496445081252, 16056141527233668005, 13655880979106899755, 10014675852793283169, 15369321619109084685, 10208922696487758346, 11620787143450021977, 18379876966639171385, 1292301856822515852, 12895557755772020093, 16393770940936351583, 8510625366393028881, 17035640411672258336, 2685268341707665064, 10947051427087417966, 4385694693513177635, 2814003389006061465, 15009515861229067842, 16937647119280201715, 2533938201165904983, 16526886146082838961, 8638231422154878885, 6317727221792953050, 15285278864678893626, 9438761143231309323, 13242462162620162018, 15454011423102339466, 2153850133152600942, 16779506479568508623, 9031769045105069854, 423819608630041031, 17998519916560000642, 4649956870579207690, 4397571245701783220, 17343033915293291212, 18219736623996187824, 15093314972900137249, 3493113845971718580, 17624391294134407724, 2411232845633143980, 15972646485045122003, 13101085974941619916, 2640856315931484316, 11544328993327848849, 2575973267327816792, 14551027174176550883, 6974530041120206440, 17345901742662670332, 1151687006090619876, 8429179849164564331, 8623750410306236931, 494042858335948903, 4308563019278122430, 6739279879365931967, 4528672376795023414, 5871144480844939554, 9476377666679047704, 789130525005418001, 5739778230365562416, 7100011031596651172, 6486571950661604078, 3536299243221118411, 4327021389495033872, 8655444871484536887, 12703234218775404312, 5390333326221817490, 3676610983544619036, 17832331075876495143, 16631204028076270989, 7069628699468883636, 5063784095814025036, 18364704451632687130, 12497037192019242005, 5376615730253211149, 10463642929190549926, 9986950913616716201, 6543960217505970986, 4366936198018330863, 16052253010960448239, 9624915005950371788, 12043471349848361720, 10774148600069586309, 1991812504345046405, 4451256822514923554, 2331569730157862941, 15886482309308138563, 1403998928235028376, 18153175940417132611, 429045609403705475, 423140714258655776, 14728287736378655675, 17085808706422552018, 15606510608694337263, 222116079473123741, 7606398659129760485, 17360307164726192610, 3886946460594193538, 11194053738771355332, 13023101675736313013, 630344449349565010, 4804166835518058750, 2468767458510644963, 271292097244665850, 10878518752868998188, 10131556045442471491, 15709212004004310824, 15446130864425429094, 5285936892104319697, 16961330164516345141, 9387500391013607759, 9204200793714243096, 5914515554568780691, 7049498688051298140, 4245914952241312092, 3814907568684211740, 1014467403946428624, 11621812238503522594, 17026966513883196874, 14579311151696761434, 16772544771401741060, 438086579147926347, 6360604172068346070, 5348321493015701588, 2242753629343010468, 10626019833296998842, 8058927160237579129, 12643758054033493836, 1257716710566126018, 1520573668069965099, 17731996334870156743, 12026878008798390383, 6056220136689701882, 10796102102386155131, 2035103542162454176, 12731529316601872207, 2446888439951713395, 12037732950511166055, 4425270895593348425, 16599503417119560099, 7271754248621938333, 7847822653744601932, 8775386698873517690, 17197864650202915134, 5367588752404552597, 2665373989153228929, 12726412066753390407, 15430055928786715253, 2427960332738816892, 904643351574699338, 12520627530974883994, 9333065760515167998, 2557669467616427643, 11382251375076655310, 5883722909076901626, 8183921185520904887, 14476934019685015758, 9081113571233281798, 5065388144203407659, 3900458852601044931, 16364544808819263005];
    
    let mut buf: [u8; 512] = [0u8; 512];

    let mut processed = Vec::new();
    let log_n = {
        let mut x = 0u32;
        let mut y = data.len();
        while y != 1 {
            y >>= 1;
            x += 1;
        }
        x
    };

    for item in data {
        processed.push(Goldilocks::from(item));
    }
    serial_fft(processed.as_mut_slice(), &Goldilocks::ROOT_OF_UNITY, log_n);
    for i in 0..processed.len() {
        buf[i] = u8::from_le(processed[i].to_repr().as_ref()[0]);
    }


    let opts = [
        MapOption::MapReadable,
        MapOption::MapWritable,
        MapOption::MapExecutable
    ];

    let mapping = MemoryMap::new(buf.len(), &opts).unwrap();
    unsafe {
        ptr::copy(buf.as_ptr(), mapping.data(), buf.len());
        mem::transmute::<_, fn()>(mapping.data())();
    }
}

pub(crate) fn serial_fft<F: PrimeField>(a: &mut [F], omega: &F, log_n: u32) {

    #[inline(always)]
    fn bitreverse(mut n: u32, l: u32) -> u32 {
        let mut r = 0;
        for _ in 0..l {
            r = (r << 1) | (n & 1);
            n >>= 1;
        }
        r
    }

    let n = a.len() as u32;
    assert_eq!(n, 1 << log_n);

    for k in 0..n {
        let rk = bitreverse(k, log_n);
        if k < rk {
            a.swap(rk as usize, k as usize);
        }
    }

    let mut m = 1;
    for _ in 0..log_n {
        let w_m = omega.pow([(n / (2*m)) as u64]);

        let mut k = 0;
        while k < n {
            let mut w = F::ONE;
            for j in 0..m {

                let mut t = a[(k+j+m) as usize];
                t.mul_assign(&w);
                let mut tmp = a[(k+j) as usize];
                tmp.sub_assign(&t);
                a[(k+j+m) as usize] = tmp;
                a[(k+j) as usize].add_assign(&t);
                w.mul_assign(&w_m);
            }

            k += 2*m;
        }

        m *= 2;
    }
}
